<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل درجات الاختبارات القصيرة</title>
    <link rel="icon" href="9999.png" type="image/png">
    <style>
        body {
    background-image: url('222.jpg'); /* إذا كانت الصورة في مجلد فرعي */
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-attachment: fixed;
        }

        body {
            background-color: #3cb2f7f8;
            /* لون الخلفية برتقالي فاتح */
            text-align: center;
            /* جميع العناصر وسط الصفحة */
        }

        table,
        th,
        td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 8px;
            margin: 0 auto;
            /* توسيط الجدول */
            
        }

        input {
            width: 80px;
        }

        .filter-container {
            margin-bottom: 10px;
        }

        #studentTable {
            display: none;
            /* إخفاء الجدول عند التحميل */
        }

        button {
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            /* زوايا مستديرة */
            cursor: pointer;
            font-weight: bold;
        }

        #showButton {
            background-color: blue;
            /* لون زر العرض */
            color: white;
            /* لون كتابة زر العرض */
        }

        #saveButton {
            background-color: green;
            /* لون زر الحفظ */
            color: white;
            /* لون كتابة زر الحفظ */
            display: none;
            /* إخفاء زر الحفظ في البداية */
        }
        #saveButton2 {
            background-color: green;
            /* لون زر الحفظ */
            color: white;
            /* لون كتابة زر الحفظ */
            display: none;
            /* إخفاء زر الحفظ في البداية */
            margin-top: 20px;
        }

        #loadingMessage {
            color: blue;
            font-weight: bold;
            display: none;
            margin-bottom: 10px;
        }

        select {
    background-color: hsl(195, 83%, 82%);
    font-size: 16px;
    font-style: normal;
    font: bold;
    padding: 5px;
    width: 120px;
    height: 40px;
    border: 2px solid #010a01;
    border-radius: 20px;
    box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1); /* إضافة ظل */
     }
label {
    background-color: hsl(195, 77%, 66%);
    font-size: 16px;
    font-style: normal;
    color: aliceblue;
    font-weight: bold;
    padding: 5px;
    width: 200px;
    height: 40px;
    border: 2px solid #010a01;
    border-radius: 10px;
    box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1); /* إضافة ظل */
}


        table,
        th,
        td {
            background-color: #f7e9d6;
            border: 1px solid black;
            border-collapse: collapse;
            padding: 8px;
            font-weight: bold;
            /* جعل الخط بولد */
            font-size: 16px;
            /* جعل حجم الخط 14 */
        }
    
        /* توسيع عمود اسم الطالب */
        td:nth-child(3),
        th:nth-child(3) {
            width: 300px;
            /* عرض عمود اسم الطالب */
        }
        

        input[type="text"],
        input[type="number"] {
            font-weight: bold;
            /* جعل الخط بولد */
            font-size: 14px;
            /* جعل حجم الخط 14 */
            width: 100%;
            /* عرض المربع يتناسب مع الخلية */
            height: 200%;
            /* عرض المربع يتناسب مع الخلية */
            box-sizing: border-box;
            /* لضمان عدم تجاوز العرض */
        }
        .readonly-field {
    border: none;
    background-color: transparent;
    pointer-events: none; /* تعطيل القدرة على التعديل */
    font-family: inherit;
    font-size: inherit;
  }
  /* تنسيق الشعار */
  .logo {
            margin-top: 10px;
            width: 150px; /* تعديل حجم الشعار */
            height: auto;
        }
    </style>
</head>

<body>

    
    <img src="9999.png" alt="Logo" class="logo">
    <h1>رصد درجات الاختبار القصير الاول 25/24</h1>

    <!-- رسالة الحفظ -->
    <div id="loadingMessage">جاري الحفظ، برجاء الانتظار...</div>

    <!-- Filter and Show Table Button -->
    <div class="filter-container">
        <label for="classFilter">جميع الصفوف</label>
            <select id="classFilter">
            <option value="">اختار الصف</option>
            <option value="خامس 1">خامس 1</option>
            <option value="خامس 2">خامس 2</option>
            <option value="خامس 3">خامس 3</option>
            <option value="خامس 4">خامس 4</option>
            <option value="سادس 1">سادس 1</option>
            <option value="سادس 2">سادس 2</option>
            <option value="سادس 3">سادس 3</option>
            <option value="سادس 4">سادس 4</option>
            <option value="سابع 1">سابع 1</option>
            <option value="سابع 2">سابع 2</option>
            <option value="سابع 3">سابع 3</option>
            <option value="سابع 4">سابع 4</option>
            <option value="ثامن 1">ثامن 1</option>
            <option value="ثامن 2">ثامن 2</option>
            <option value="ثامن 3">ثامن 3</option>
            <option value="ثامن 4">ثامن 4</option>
            <option value="تاسع 1">تاسع 1</option>
            <option value="تاسع 2">تاسع 2</option>
            <option value="تاسع 3">تاسع 3</option>
            <option value="تاسع 4">تاسع 4</option>
            <option value="عاشر 1">عاشر 1</option>
            <option value="عاشر 2">عاشر 2</option>
            <option value="عاشر 3">عاشر 3</option>
            <option value="عاشر 4">عاشر 4</option>
            <!-- Add other class options here -->
        </select>

        <label for="subjectFilter">جميع المواد</label>
        <select id="subjectFilter">
            <option value="">-- اختار المادة --</option>
            <option value="aslm">التربية الاسلامية</option>
            <option value="arb">اللغة العربية</option>
            <option value="math">الرياضيات</option>
            <option value="since">العلوم</option>
            <option value="drasa">الدراسات</option>
            <option value="eng">اللغة الانجليزية</option>
            <option value="fyz">فيزياء</option>
            <option value="kims">كيمياء</option>
            <option value="ahya">احياء</option>
        </select>

        <button id="showButton" onclick="showTable()">عــرض</button> <!-- Button to show the table -->
        <button id="saveButton" onclick="updateAllStudents()">حفظ الدرجات</button> <!-- Button to save all changes -->
    </div>

    <!-- Table to display the data -->
    <table id="studentTable">
        <thead>
            <tr>
                <th style="width: 35px;">م</th>
                <th style="width: 55px;">الصف</th>
                <th style="width: auto;">اسم الطالب</th>
                <th style="width: 50px;">اسلامية</th>
                <th style="width: 50px;">عربي</th>
                <th style="width: 50px;">رياضيات</th>
                <th style="width: 50px;">علوم</th>
                <th style="width: 50px;">دراسات</th>
                <th style="width: 50px;">انجليزي</th>
                <th style="width: 50px;">فيزياء</th>
                <th style="width: 50px;">كيمياء</th>
                <th style="width: 50px;">احياء</th>
            </tr>
        </thead>
        <tbody>
            <!-- Data will be populated here -->
        </tbody>
    </table>
    <button id="saveButton2" onclick="updateAllStudents()">حفظ الدرجات</button> <!-- Button2 to save all changes -->
    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbztCJGQzunQW6HJen1ggtgZ-IlQISvqzQ85_7_g0H3UmJM_Ya28fFiGIu1-922Gmiej/exec';

        function loadData() {
            fetch(scriptURL)
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.querySelector("#studentTable tbody");
                    tableBody.innerHTML = ''; // Clear existing data
                    data.forEach((row) => {
                        const newRow = document.createElement("tr");
                        newRow.innerHTML = `
                            <td>${row.id}</td>
                            <td><input type="text" value="${row.cl_num}" id="cl_num_${row.id}" class="readonly-field"></td> 
                            <td><input type="text" value="${row.student_name}" id="student_name_${row.id}" class="readonly-field"></td>
                            <td><input type="number" value="${row.aslm}" id="aslm_${row.id}"></td>
                            <td><input type="number" value="${row.arb}" id="arb_${row.id}"></td>
                            <td><input type="number" value="${row.math}" id="math_${row.id}"></td>
                            <td><input type="number" value="${row.since}" id="since_${row.id}"></td>
                            <td><input type="number" value="${row.drasa}" id="drasa_${row.id}"></td>
                            <td><input type="number" value="${row.eng}" id="eng_${row.id}"></td>
                            <td><input type="number" value="${row.fyz}" id="fyz_${row.id}"></td>
                            <td><input type="number" value="${row.kims}" id="kims_${row.id}"></td>
                            <td><input type="number" value="${row.ahya}" id="ahya_${row.id}"></td>
                        `;
                        tableBody.appendChild(newRow);
                    });
                });
        }

        function showTable() {
            const classFilterValue = document.getElementById('classFilter').value;
            const subjectFilterValue = document.getElementById('subjectFilter').value;

            if (classFilterValue && subjectFilterValue) {
                document.getElementById('studentTable').style.display = 'table'; // عرض الجدول
                document.getElementById('saveButton').style.display = 'inline-block'; // عرض زر الحفظ
                document.getElementById('saveButton2').style.display = 'inline-block'; // عرض زر الحفظ2
                filterData(classFilterValue, subjectFilterValue); // تطبيق الفلترة
            } else {
                alert('برجاء اختيار الصف و المادة معاً.');
            }
        }
        function validateInput(input) {
    const maxValue = 20; // الحد الأقصى للقيمة المسموح بها
    const value = parseInt(input.value);

    // التحقق من أن القيمة لا تتعدى 20
    if (value > maxValue) {
        input.value = maxValue; // ضبط القيمة إلى 20 إذا كانت أعلى
    }

    // التأكد من أن الإدخال لا يتجاوز رقمين
    if (input.value.length > 2) {
        input.value = input.value.slice(0, 2); // تقصير الإدخال إلى أول رقمين
    }
}

        function filterData(classFilterValue, subjectFilterValue) {
            const tableBody = document.querySelector("#studentTable tbody");
            const rows = tableBody.querySelectorAll("tr");
            const headers = document.querySelectorAll("#studentTable th");

            rows.forEach(row => {
                const classNumber = row.cells[1].querySelector('input').value; // Class number

                if (classNumber.includes(classFilterValue)) {
                    row.style.display = ''; // Show row

                    // Hide all subjects except the selected one and basic info
                    for (let i = 3; i <= 11; i++) {
                        if (i === getColumnIndex(subjectFilterValue)) {
                            row.cells[i].style.display = ''; // Show selected subject
                        } else {
                            row.cells[i].style.display = 'none'; // Hide other subjects
                        }
                    }
                    // Hide other headers
                    for (let i = 3; i <= 11; i++) {
                        if (i !== getColumnIndex(subjectFilterValue)) {
                            headers[i].style.display = 'none';
                        } else {
                            headers[i].style.display = '';
                        }
                    }
                } else {
                    row.style.display = 'none'; // Hide row
                }
            });
        }

        function getColumnIndex(subject) {
            switch (subject) {
                case 'aslm': return 3;
                case 'arb': return 4;
                case 'math': return 5;
                case 'since': return 6;
                case 'drasa': return 7;
                case 'eng': return 8;
                case 'fyz': return 9;
                case 'kims': return 10;
                case 'ahya': return 11;
                default: return -1;
            }
        }

         // إدارة الأخطاء والتأكد من عرض الجدول بالشكل الصحيح
    function showTable() {
        const classFilterValue = document.getElementById('classFilter').value;
        const subjectFilterValue = document.getElementById('subjectFilter').value;

        // تحقق أن كلا الفيلترين تم اختيارهما
        if (classFilterValue && subjectFilterValue) {
            try {
                document.getElementById('studentTable').style.display = 'table'; // عرض الجدول
                document.getElementById('saveButton').style.display = 'inline-block'; // عرض زر الحفظ
                document.getElementById('saveButton2').style.display = 'inline-block'; // عرض زر الحفظ2
                filterData(classFilterValue, subjectFilterValue); // تطبيق الفلترة
            } catch (error) {
                console.error("حدث خطأ أثناء عرض الجدول: ", error);
                alert('حدث خطأ أثناء عرض البيانات. يرجى المحاولة مرة أخرى.');
                document.getElementById('studentTable').style.display = 'none'; // إخفاء الجدول في حالة حدوث خطأ
                document.getElementById('saveButton').style.display = 'none'; // إخفاء زر الحفظ
                document.getElementById('saveButton2').style.display = 'none'; // إخفاء زر الحفظ
            }
        } else {
            alert('برجاء اختيار الصف والمادة معاً.');
            document.getElementById('studentTable').style.display = 'none'; // إخفاء الجدول إذا لم يتم اختيار الفيلتر
        }
    }

    // إدارة حفظ البيانات
    function updateAllStudents() {
        const tableBody = document.querySelector("#studentTable tbody");
        const rows = tableBody.querySelectorAll("tr");

        if (rows.length === 0) {
            alert("لا توجد بيانات لحفظها.");
            return;
        }

        let formData = new FormData();

        rows.forEach(row => {
            const id = row.cells[0].textContent; // Get the student ID
            formData.append(`id_${id}`, id);
            formData.append(`aslm_${id}`, row.querySelector(`#aslm_${id}`).value);
            formData.append(`arb_${id}`, row.querySelector(`#arb_${id}`).value);
            formData.append(`math_${id}`, row.querySelector(`#math_${id}`).value);
            formData.append(`since_${id}`, row.querySelector(`#since_${id}`).value);
            formData.append(`drasa_${id}`, row.querySelector(`#drasa_${id}`).value);
            formData.append(`eng_${id}`, row.querySelector(`#eng_${id}`).value);
            formData.append(`fyz_${id}`, row.querySelector(`#fyz_${id}`).value);
            formData.append(`kims_${id}`, row.querySelector(`#kims_${id}`).value);
            formData.append(`ahya_${id}`, row.querySelector(`#ahya_${id}`).value);
        });

        document.getElementById('loadingMessage').style.display = 'block'; // Show loading message

        fetch(scriptURL, {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loadingMessage').style.display = 'none'; // Hide loading message
                alert('تم حفظ الدرجات بنجاح!');
                document.getElementById('studentTable').style.display = 'none'; // Hide the table after saving
                document.getElementById('saveButton').style.display = 'none'; // Hide the save button after saving
                document.getElementById('saveButton2').style.display = 'none'; // Hide the save button
            })
            .catch(error => {
                document.getElementById('loadingMessage').style.display = 'none'; // Hide loading message
                console.error("حدث خطأ أثناء حفظ البيانات: ", error);
                alert('حدث خطأ أثناء حفظ البيانات. يرجى المحاولة مرة أخرى.');
            });
        }

        // Load the data when the page loads
        window.onload = loadData;

    </script>

</body>

</html>